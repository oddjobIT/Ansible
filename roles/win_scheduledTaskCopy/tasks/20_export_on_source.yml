---
- name: 20 Ensure export directory exists
  delegate_to: "{{ source_server }}"
  ansible.windows.win_file:
    path: "{{ export_dir }}"
    state: directory
  

- name: 20 Export tasks to XML
  delegate_to: "{{ source_server }}"
  ansible.windows.win_shell: |
    $name = "{{ item }}"
    $safe = $name -replace '[\\/]', '_'
    $out  = Join-Path "{{ export_dir }}" ($safe + ".xml")
    schtasks /Query /TN "$name" /XML | Out-File -FilePath $out -Encoding Unicode
    if ($LASTEXITCODE -ne 0) { throw "Failed to export task: $name" }
  loop: "{{ task_names }}"
  