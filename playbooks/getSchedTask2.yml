---
- name: Collect inputs and build scoped host group (source + destination only)
  hosts: localhost
  gather_facts: false

  vars_prompt:
    - name: source_server
      prompt: "Enter SOURCE server (export from)"
      private: no

    - name: destination_server
      prompt: "Enter DESTINATION server (import to)"
      private: no

    - name: task_name_input
      prompt: "Enter scheduled task name to copy (one task). Example: Daily Google Ping"
      private: no
      default: "Daily Google Ping"

  vars:
    # Windows paths (override via -e or AAP Survey if desired)
    export_dir: 'D:\temp\TaskExport'
    import_dir: 'C:\temp\TaskImport'
    controller_export_dir: './task_exports'

  tasks:
    - name: Normalize task_names list
      ansible.builtin.set_fact:
        task_names:
          - "{{ task_name_input | trim }}"

    - name: Validate required vars
      ansible.builtin.assert:
        that:
          - source_server | length > 0
          - destination_server | length > 0
          - source_server != destination_server
          - task_names[0] | length > 0
        fail_msg: "Source/destination must be non-empty and different; task name must be non-empty."

    # Optional: validate inventory membership (recommended if these are inventory hostnames)
    - name: Validate servers exist in inventory
      ansible.builtin.assert:
        that:
          - source_server in groups['all']
          - destination_server in groups['all']
        fail_msg: >
          source_server and destination_server must be inventory hostnames (present in groups['all']).
          If you want to pass IP/FQDN not in inventory, we can adapt add_host to set ansible_host.

    - name: Add source and destination to scoped group
      ansible.builtin.add_host:
        name: "{{ item }}"
        groups: scoped_targets
      loop:
        - "{{ source_server }}"
        - "{{ destination_server }}"

    - name: Ensure controller export folder exists
      ansible.builtin.file:
        path: "{{ controller_export_dir }}"
        state: directory


- name: Export from source and import to destination (scoped targets only)
  hosts: scoped_targets
  gather_facts: false

  vars:
    export_dir: 'D:\temp\TaskExport'
    import_dir: 'C:\temp\TaskImport'
    controller_export_dir: './task_exports'

  tasks:
    # -------------------------
    # EXPORT on source
    # -------------------------
    - name: Ensure export directory exists on source
      ansible.windows.win_file:
        path: "{{ export_dir }}"
        state: directory
      when: inventory_hostname == source_server

    - name: Export task(s) to XML on source
      ansible.windows.win_shell: |
        $name = "{{ item }}"
        $safe = $name -replace '[\\/]', '_'
        $out  = Join-Path "{{ export_dir }}" ($safe + ".xml")

        schtasks /Query /TN "$name" /XML | Out-File -FilePath $out -Encoding Unicode
        if ($LASTEXITCODE -ne 0) { throw "Failed to export task: $name" }
      loop: "{{ task_names }}"
      changed_when: false
      when: inventory_hostname == source_server

    - name: Fetch exported XML files to controller
      ansible.builtin.fetch:
        src: "{{ export_dir }}/{{ item | regex_replace('[\\\\/]', '_') }}.xml"
        dest: "{{ controller_export_dir }}/"
        flat: true
      loop: "{{ task_names }}"
      when: inventory_hostname == source_server

    - name: Fetch exported XML files to controller
      ansible.builtin.fetch:
        src: "{{ export_dir }}/{{ item | regex_replace('[\\\\/]', '_') }}.xml"
        dest: "./task_exports/"
        flat: true
      loop: "{{ task_names }}"
    # -------------------------
    # IMPORT on destination
    # -------------------------
    - name: Ensure import directory exists on destination
      ansible.windows.win_file:
        path: "{{ import_dir }}"
        state: directory
      when: inventory_hostname == destination_server

    - name: Copy XML exports from controller to destination
      ansible.windows.win_copy:
        src: "{{ controller_export_dir }}/{{ item | regex_replace('[\\\\/]', '_') }}.xml"
        dest: "{{ import_dir }}\\{{ item | regex_replace('[\\\\/]', '_') }}.xml"
      loop: "{{ task_names }}"
      when: inventory_hostname == destination_server

    - name: Register task(s) from XML on destination as SYSTEM (overwrite)
      ansible.windows.win_shell: |
        $name = "{{ item }}"
        $safe = $name -replace '[\\/]', '_'
        $xml  = Join-Path "{{ import_dir }}" ($safe + ".xml")

        schtasks /Create /TN "$name" /XML "$xml" /RU "SYSTEM" /F
        if ($LASTEXITCODE -ne 0) { throw "Failed to import task: $name" }
      loop: "{{ task_names }}"
      when: inventory_hostname == destination_server
